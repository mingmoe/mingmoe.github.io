<!DOCTYPE html>

<html lang="zh-CN" class="mingBackground mingBased">



<head>
    
    <meta charset="utf-8">

    
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta name="author" content="MingMoe & Thanks Octopress">

    
    <title>
ä½¿ç”¨rustç¼–å†™ä¸€ä¸ªUEFIå¼•å¯¼ç¨‹åº
- MingMoeçš„ç½‘ç»œåšå®¢
    </title>

    
    


<link type="text/css" rel="stylesheet" href="https://blog.kawayi.moe//css/normalize.css">




<link type="text/css" rel="stylesheet" href="https://blog.kawayi.moe/scss/ming.css">


<link type="text/css" rel="stylesheet" href="https://blog.kawayi.moe//css/syntax.css">



<style>    

    
    .mingBackground{
        background: url(/Background.webp);
    }

    
    .mingBased{
        font-size: 16px;
    }

</style>





<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Pacifico&display=swap" rel="stylesheet">

</head>



<body class="mingBody">

    
    
<header class="mingFacade">
    <h1>
        æ¬¢è¿æ¥åˆ°å¤§æ˜é…±çš„ç½‘ç»œåšå®¢ğŸ“š
    </h1>

    <p>
        ä¸€ä¸ªæŠ€æœ¯å®…çš„ç½‘ç»œåšå®¢â”—|ï½€Oâ€²|â”› ~~
    </p>
</header>

    
    

<nav class="mingNav">
    
    <ul>
        
        <li>
            <a href="https://blog.kawayi.moe//">Blog</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe//about">About Me</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe//archives">Archives</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe//categories">Categories</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe//tags">Tags</a>
        </li>

    </ul>

</nav>



<nav class="mingMenu">
    
    <select onchange="location = this.value;">
        
        <option>Navigate</option>
        
        <option value="https://blog.kawayi.moe//">ğŸ”— Blog</option>
        <option value="https://blog.kawayi.moe//about">ğŸ”— About Me</option>
        <option value="https://blog.kawayi.moe//archives">ğŸ”— Archives</option>
        <option value="https://blog.kawayi.moe//categories">ğŸ”— Categories</option>
        <option value="https://blog.kawayi.moe//tags">ğŸ”— Tags</option>
    </select>

</nav>

    
    
    <div class="mingContentWrapper">
        
        <main class="mingContent">
            


<div class="mingPostStyle">
    
    <div class="postHeader">
        
        <p></span> Sunday, July 4, 2021 </span><span> | <a href="/tags/uefi">uefi</a></span><span> | <a href="/tags/rust">rust</a></span></p>
    </div>

    
    <div class="postTitle">
        <h1>ä½¿ç”¨rustç¼–å†™ä¸€ä¸ªUEFIå¼•å¯¼ç¨‹åº</h1>
    </div>

    
    <div class="postContent">
        <p>åœ¨æœ¬ç¯‡æ–‡ç« ï¼Œå’±å°†ä¸€èµ·ä½¿ç”¨rustå®ç°ä¸€ä¸ªUEFIå¼•å¯¼ç¨‹åºï¼</p>
<p>å°†åŠ è½½ä¸€ä¸ªç®€å•çš„å†…æ ¸ã€‚</p>
<p>å€¼å¾—çš„æ˜¯ï¼šä»£ç æœªç»è¿‡æµ‹è¯•ï¼Œæœ‰é—®é¢˜å¯ä»¥è”ç³»å’±ã€‚</p>
<p>é¦–å…ˆï¼Œå’±ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> $ cargo new hello_uefi
</span></span></code></pre></td></tr></table>
</div>
</div><p>å’±ä»¬è¿˜éœ€è¦ä½¿ç”¨x86_64-unknown-uefiè¿™ä¸ªtargetã€‚ä¸è¿‡ä¸€èˆ¬ä¸éœ€è¦å®‰è£…ã€‚</p>
<p>æ¥ç€ï¼Œå’±ä»¬è®¾ç½®å’±ä»¬çš„<code>cargo.toml</code>ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨uefi-rsè¿™ä¸ªåº“ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;hello_uefi&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">edition</span> <span class="p">=</span> <span class="s2">&#34;2018&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">profile</span><span class="p">.</span><span class="nx">dev</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c"># ç¦ç”¨æ ˆå±•å¼€</span>
</span></span><span class="line"><span class="cl"><span class="nx">panic</span> <span class="p">=</span> <span class="s2">&#34;abort&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">profile</span><span class="p">.</span><span class="nx">release</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c"># åŒä¸Š</span>
</span></span><span class="line"><span class="cl"><span class="nx">panic</span> <span class="p">=</span> <span class="s2">&#34;abort&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c"># å¼•å…¥uefi</span>
</span></span><span class="line"><span class="cl"><span class="nx">uefi</span> <span class="p">=</span> <span class="s2">&#34;0.11.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åç¼–å†™<code>main.rs</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="c1">// ç¦ç”¨è‡ªå¸¦çš„ä¸œè¥¿
</span></span></span><span class="line"><span class="cl"><span class="c1">// åŒæ—¶å¯ç”¨ä¸€äº›feature
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#![no_std]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![no_main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![feature(abi_efiapi)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![feature(panic_info_message)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![feature(alloc_error_handler)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">panic</span>::<span class="n">PanicInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">alloc</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// è½½å…¥uefiå®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Write</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">uefi</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">uefi</span>::<span class="n">CStr16</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// å…¨å±€ç³»ç»Ÿè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="no">IMAGE_HANDLE</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Handle</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="no">IMAGE_SYSTEM_TABLE</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">SystemTable</span><span class="o">&lt;</span><span class="n">Boot</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// å…¥å£å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="cp">#[no_mangle]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&#34;C&#34;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">efi_main</span><span class="p">(</span><span class="n">handle</span>: <span class="nc">Handle</span><span class="p">,</span><span class="w"> </span><span class="n">system_table</span>: <span class="nc">SystemTable</span><span class="o">&lt;</span><span class="n">Boot</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Status</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// åˆå§‹åŒ–å…¨å±€å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="no">IMAGE_HANDLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="no">IMAGE_SYSTEM_TABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">system_table</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ä»€ä¹ˆéƒ½ä¸å¹²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// panicæ“¦å±è‚¡å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="cp">#[panic_handler]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">panic</span><span class="p">(</span><span class="n">panic_info</span>: <span class="kp">&amp;</span><span class="nc">PanicInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ä»€ä¹ˆéƒ½ä¸å¹²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†ç‰¹æ®Šçš„targetï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±æ„å»ºæ ‡å‡†åº“ç­‰åŸºç¡€æªæ–½ã€‚</p>
<p>è¿˜éœ€è¦compiler_builtinsæä¾›çš„ä¸€äº›åˆ—æ“ä½œå†…å­˜çš„å‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬å†ç¼–å†™ä¸€ä¸ªè„šæœ¬ä»¥æ„å»ºæ­¤é¡¹ç›®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cargo build --target<span class="o">=</span>x86_64-unknown-uefi -Z build-std<span class="o">=</span>core,compiler_builtins,alloc -Z build-std-features<span class="o">=</span>compiler-builtins-mem
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åº”è¯¥å°±å¯ä»¥ç¼–è¯‘æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªuefiç¨‹åºäº†ï¼</p>
<p>ä¸å‡ºæ‰€æ–™ï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°äº†ä¸€ä¸ªé”™è¯¯:</p>
<pre tabindex="0"><code>error: no global memory allocator found but one is required; link to std or add `#[global_allocator]` to a static item that implements the GlobalAlloc trait.
</code></pre><p>çœ‹èµ·æ¥ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç»™è¿™ä¸ªç¨‹åºæ·»åŠ å†…å­˜åˆ†é…å™¨ã€‚è§£å†³æ–¹æ¡ˆä¹Ÿéƒ½ä¸éš¾:</p>
<ul>
<li>
<p>æ·»åŠ ä¸€ä¸ªå†…å­˜åˆ†é…å™¨ï¼Œé‰´äºUEFIå·²ç»æä¾›äº†éå¸¸ç®€é™‹çš„å†…å­˜&quot;ç®¡ç†&quot;ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆã€‚</p>
</li>
<li>
<p>åˆ é™¤æºç ä¸­çš„<code>extern crate alloc;</code>ã€‚</p>
</li>
</ul>
<p>ä¸‹é¢æ˜¯å†…å­˜åˆ†é…å™¨çš„æºç :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">alloc</span>::<span class="p">{</span><span class="n">GlobalAlloc</span><span class="p">,</span><span class="w"> </span><span class="n">Layout</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">uefi</span>::<span class="n">table</span>::<span class="n">boot</span>::<span class="n">MemoryType</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// UEfiå†…å­˜åˆ†é…å™¨
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">UefiAllocator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// å®ç°å†…å­˜åˆ†é…å™¨
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">GlobalAlloc</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">UefiAllocator</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IMAGE_SYSTEM_TABLE</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">boot_services</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å†…å­˜ç±»å‹ä¸ºLOADER_DATA(å³æ•°æ®)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">boot</span><span class="p">.</span><span class="n">allocate_pool</span><span class="p">(</span><span class="n">MemoryType</span>::<span class="no">LOADER_DATA</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dealloc</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">_layout</span>: <span class="nc">Layout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IMAGE_SYSTEM_TABLE</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">boot_services</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">boot</span><span class="p">.</span><span class="n">free_pool</span><span class="p">(</span><span class="n">ptr</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// è®¾ç½®å†…å­˜åˆ†é…å™¨
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="cp">#[global_allocator]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="no">GLOBAL</span>: <span class="nc">UefiAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UefiAllocator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// è®¾ç½®åˆ†é…errorå¤„ç†å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="cp">#[alloc_error_handler]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">alloc_error_catch</span><span class="p">(</span><span class="n">layout</span>: <span class="nc">core</span>::<span class="n">alloc</span>::<span class="n">Layout</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">panic!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;Couldn&#39;t alloc memory! Size:</span><span class="si">{0}</span><span class="s"> Align:</span><span class="si">{1}</span><span class="s">&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">layout</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">layout</span><span class="p">.</span><span class="n">align</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>UEFIä¸­çš„allocate_pool()å†…å­˜ä»¥8å­—èŠ‚å¯¹é½ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†å…³å¿ƒæ­¤äº‹ï¼ˆ8å­—èŠ‚æ˜¯rustçš„æœ€å¤§å¯¹é½ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨åº”è¯¥å¯ä»¥é¡ºåˆ©é€šè¿‡ç¼–è¯‘ã€‚</p>
<p>ä¸‹é¢ï¼Œå’±ä»¬å°±å¯ä»¥å¼€å§‹è¿›è¡Œæµ‹è¯•å•¦ï¼</p>
<p>æœ‰ä¸€ä¸ªåä¸º<code>uefi-run</code>çš„rustçš„å·¥å…·å¯ä»¥å¸®åˆ°æˆ‘ä»¬ï¼Œinstall at once:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> $ cargo install uefi-run
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨æ³•ä¹Ÿå¾ˆç®€å•:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> $ uefi-run -b ä½ çš„OVMF.fdæ‰€åœ¨çš„åœ°å€  -q ä½ çš„qemuå¯æ‰§è¡Œæ–‡ä»¶çš„åœ°å€ï¼Œé€šå¸¸æ˜¯qemu-system-x86_64  ä½ çš„ELFæ–‡ä»¶æ‰€åœ¨çš„åœ°å€ -- ä½ çš„QEMUå‚æ•°åˆ—è¡¨...
</span></span></code></pre></td></tr></table>
</div>
</div><p>OVMF.fdå¯ä»¥ä»ä¸€äº›Linuxå‘è¡Œç‰ˆçš„åŒ…ç®¡ç†å™¨ä¸­æ‰¾åˆ°ã€‚
ä¹Ÿå¯ä»¥ä»<a href="https://github.com/tianocore/tianocore.github.io/wiki/OVMF">è¿™é‡Œ</a>æ‰¾åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚</p>
<p>ä¸å‡ºæ„å¤–ï¼Œæˆ‘ä»¬çš„ç¨‹åºåº”è¯¥æ²¡ä»€ä¹ˆåŠ¨ä½œã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥ç›´æ¥åŠ è½½å†…æ ¸äº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="sd">/// è¯»å–æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="sd">/// 
</span></span></span><span class="line"><span class="cl"><span class="sd">/// è¿”å›è¯»å–åˆ°çš„æ–‡ä»¶çš„å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">path</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è·å–å¼•å¯¼æœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">boot_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IMAGE_SYSTEM_TABLE</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">boot_services</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è·å–fsæœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">boot_services</span><span class="p">.</span><span class="n">locate_protocol</span>::<span class="o">&lt;</span><span class="n">SimpleFileSystem</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">some</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">some</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">_err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&#34;Load SimpleFileSystem failed down!&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">crate</span>::<span class="n">tool</span>::<span class="n">print_fmt</span><span class="p">(</span><span class="fm">format_args!</span><span class="p">(</span><span class="s">&#34;Get fs done.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ‰“å¼€æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">dic</span>: <span class="nc">Directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">open_volume</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">FileMode</span>::<span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">FileAttribute</span>::<span class="n">empty</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è¯»å–æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">FileType</span>::<span class="n">Regular</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">reader</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">into_type</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è·å–æ–‡ä»¶å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// è®¾ç½®ç¼“å†²åŒº...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// åº”è¯¥ä¸ä¼šæº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">info_buffer</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">512</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">512</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">file_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">get_info</span>::<span class="o">&lt;</span><span class="n">FileInfo</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">info_buffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">file_size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è¯»è¿›ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">text_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="n">file_size</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()].</span><span class="n">into_boxed_slice</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">text_buffer</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è½¬æ¢ä¸ºå­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="p">(</span><span class="o">&amp;</span><span class="n">text_buffer</span><span class="p">).</span><span class="n">to_vec</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&#34;Filed to open file. Look like a Directory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>emmm&hellip;DONE OT TODO</p>
    </div>

    
    <div class="postFooter">
        <p>Posted by MingMoe.</p>
        <p>Last update Sunday, July 4, 2021.</p>
    </div>

</div>


        </main>
        
        
        


<aside class="mingSider">

    <p>æ¬¢è¿æ¥åˆ°æœ¬ç«™[]~ï¼ˆï¿£â–½ï¿£ï¼‰~*</p>

    
    <div>
        <iframe style="overflow: hidden;display: flex;width:100%" width="300" height="30" frameborder="0" scrolling="no" hspace="0" src="https://i.tianqi.com/index.php?c=code&id=34&icon=1"></iframe>
    </div>

    
    <div>
        <a class="twitter-timeline" data-lang="zh-cn" data-height="2048" href="https://twitter.com/ming_moe_?ref_src=twsrc%5Etfw"></a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>

</aside>
    </div>

    
    

<footer class="mingFooter">

    <p>Powered by <a href="https://gohugo.io/">Hugo</a>.Copyright Â©  2021-2023 MingMoe.<br>

    <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
        <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®
        </a>è¿›è¡Œè®¸å¯ã€‚

    </p>

</footer>

</body>


</html>
