<!DOCTYPE html>

<html lang="zh-CN" class="mingBackground mingBased">



<head>
    
    <meta charset="utf-8">

    
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta name="author" content="MingMoe & Thanks Octopress">

    
    <title>
Netty Channel Initçš„handleræ·»åŠ é¡ºåºå¯¹ç¨‹åºçš„å½±å“
- MingMoeçš„ç½‘ç»œåšå®¢
    </title>

    
    


<link type="text/css" rel="stylesheet" href="https://blog.kawayi.moe/css/normalize.css">




<link type="text/css" rel="stylesheet" href="https://blog.kawayi.moe/scss/ming.css">


<link type="text/css" rel="stylesheet" href="https://blog.kawayi.moe/css/syntax.css">



<style>    

    
    .mingBackground{
        background: url(/Background.webp);
    }

    
    .mingBased{
        font-size: 16px;
    }

</style>





<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Pacifico&display=swap" rel="stylesheet">

</head>



<body class="mingBody">

    
    
<header class="mingFacade">
    <h1>
        æ¬¢è¿æ¥åˆ°å¤§æ˜é…±çš„ç½‘ç»œåšå®¢ğŸ“š
    </h1>

    <p>
        ä¸€ä¸ªæŠ€æœ¯å®…çš„ç½‘ç»œåšå®¢â”—|ï½€Oâ€²|â”› ~~
    </p>
</header>

    
    

<nav class="mingNav">
    
    <ul>
        
        <li>
            <a href="https://blog.kawayi.moe/">Blog</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe/about">About Me</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe/archives">Archives</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe/categories">Categories</a>
        </li>

        
        <li>
            <a href="https://blog.kawayi.moe/tags">Tags</a>
        </li>

    </ul>

</nav>



<nav class="mingMenu">
    
    <select onchange="location = this.value;">
        
        <option>Navigate</option>
        
        <option value="https://blog.kawayi.moe/">ğŸ”— Blog</option>
        <option value="https://blog.kawayi.moe/about">ğŸ”— About Me</option>
        <option value="https://blog.kawayi.moe/archives">ğŸ”— Archives</option>
        <option value="https://blog.kawayi.moe/categories">ğŸ”— Categories</option>
        <option value="https://blog.kawayi.moe/tags">ğŸ”— Tags</option>
    </select>

</nav>

    
    
    <div class="mingContentWrapper">
        
        <main class="mingContent">
            


<div class="mingPostStyle">
    
    <div class="postHeader">
        
        <p></span> Saturday, October 23, 2021 </span><span> | <a href="/tags/netty">netty</a></span><span> | <a href="/tags/java">java</a></span></p>
    </div>

    
    <div class="postTitle">
        <h1>Netty Channel Initçš„handleræ·»åŠ é¡ºåºå¯¹ç¨‹åºçš„å½±å“</h1>
    </div>

    
    <div class="postContent">
        <!--TODO-->
<p>ä»Šå¤©åœ¨ç ”ç©¶nettyçš„æ—¶å€™ï¼Œç¢°åˆ°äº†ä¸€ä¸ªchannel initçš„é—®é¢˜:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NettyChannelInit</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">NioSocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">NioSocketChannel</span>  <span class="n">socketChannel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">var</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
        <span class="n">pipeline</span>
                <span class="c1">// æ·»åŠ ä¸€ä¸ªæ‹†åŒ…å™¨ (input)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;packet length parser&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
                        <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
                        <span class="n">0</span><span class="o">,</span>
                        <span class="n">4</span><span class="o">,</span>
                        <span class="n">0</span><span class="o">,</span>
                        <span class="c1">// ä¸¢å¼ƒé•¿åº¦
</span><span class="c1"></span>                        <span class="n">4</span>
                <span class="o">))</span>
                <span class="c1">// æ·»åŠ ä¸€ä¸ªåŒ…åˆ†ç±»å™¨ (input)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;packet classifier&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">PacketClassifier</span><span class="o">())</span>
                <span class="c1">// æ·»åŠ ä¸€äº›å®é™…å¤„ç†åŒ…çš„handle (input &amp;&amp; output)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;packet ping handle&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">PingPacketHandle</span><span class="o">())</span>
                <span class="c1">// æ·»åŠ ä¸€ä¸ªè¾“å‡ºè§£ç å™¨ (output)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;output encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">PacketEncoder</span><span class="o">())</span>
                <span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç çš„ä¾æ® input-process-output çš„handleré€»è¾‘é¡ºåºï¼ˆå³è§£ç è¾“å…¥handler-é€»è¾‘handler-ç¼–ç è¾“å‡ºhandlerï¼‰æ¥æ·»åŠ handlerã€‚è¿™å°†ä¼šé”™è¯¯çš„å·¥ä½œã€‚</p>
<p>ä¸Šé¢çš„é€»è¾‘æ˜¯:</p>
<pre tabindex="0"><code>      Input
           |
           |
           |
+----------+-------------+  Channel Pipeline
|          |             |
| +--------v-----------+ |
| |                    |&lt;+---First
| |                    | |
| | Handler            | |
| |                    | |
| +--------+-----------+ |
|          |             |
| +--------v-----------+ |
| |                    | |
| |                    | |
| | Handler            | |
| |                    | |
| +--------+-----------+ |
|          |             |
| +--------v-----------+ |
| |                    | |
| | Handler            | |
| |                    | |
| +--------+-----------+ |
|          |             |
| +--------v-----------+ |
| |                    | |
| | Handler            |&lt;+---Last
| +--------+-----------+ |
|          |             |
+----------+-------------+
           v
        Output
</code></pre><p>å®é™…ä¸­ï¼Œè¿™æ®µä»£ç æ— æ³•æ­£ç¡®å¤„ç†è¯·æ±‚â€”â€”ç‰¹åˆ«æ˜¯å¯¹äºè¾“å‡ºã€‚</p>
<p><a href="https://netty.io/4.1/api/io/netty/channel/ChannelPipeline.html">å®˜æ–¹æ–‡æ¡£</a>ç»™äº†ä¸€ä¸ªå°å°çš„ä¾‹å­:</p>
<pre tabindex="0"><code>  +---------------------------------------------------+---------------+
  |                           ChannelPipeline         |               |
  |                                                  \|/              |
  |    +---------------------+            +-----------+----------+    |
  |    | Inbound Handler  N  |            | Outbound Handler  1  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  |               |                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler N-1 |            | Outbound Handler  2  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  .               |
  |               .                                   .               |
  | ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|
  |        [ method call]                       [method call]         |
  |               .                                   .               |
  |               .                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler  2  |            | Outbound Handler M-1 |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  |               |                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler  1  |            | Outbound Handler  M  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  +---------------+-----------------------------------+---------------+
                  |                                  \|/
  +---------------+-----------------------------------+---------------+
  |               |                                   |               |
  |       [ Socket.read() ]                    [ Socket.write() ]     |
  |                                                                   |
  |  Netty Internal I/O Threads (Transport Implementation)            |
  +-------------------------------------------------------------------+
</code></pre><p>è¿™ä¸ªä¾‹å­å¯èƒ½å¤ªè¿‡äºä¸ç›´è§‚äº†ã€‚</p>
<p>è€Œä¸”å®˜æ–¹æ ‡æ³¨äº†ä¸€äº›å…³äºæ·»åŠ handlerçš„ä¾‹å­:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyProtocolDecoder</span><span class="o">());</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyProtocolEncoder</span><span class="o">());</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="s">&#34;handler&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyBusinessLogicHandler</span><span class="o">());</span>

 <span class="c1">// å¦ä¸€ä¸ªä¾‹å­
</span><span class="c1"></span> <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="o">...;</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">InboundHandlerA</span><span class="o">());</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">InboundHandlerB</span><span class="o">());</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;3&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">OutboundHandlerA</span><span class="o">());</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;4&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">OutboundHandlerB</span><span class="o">());</span>
 <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;5&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">InboundOutboundHandlerX</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥è§åˆ°ï¼Œå®˜æ–¹ç»™å‡ºçš„handleræ·»åŠ é¡ºåºåº”è¯¥æ˜¯: input-output-process</p>
<p>å¹¶ä¸”ç»™äº†ä¸€æ®µæ–‡å­—ï¼ˆå¯¹äºä¸Šé¢ä»£ç çš„åä¸€ä¸ªä¾‹å­ï¼‰:</p>
<pre tabindex="0"><code> - 3 and 4 don't implement ChannelInboundHandler, and therefore the actual evaluation order of an inbound event will be: 1, 2, and 5.
 - 1 and 2 don't implement ChannelOutboundHandler, and therefore the actual evaluation order of a outbound event will be: 5, 4, and 3.
 - If 5 implements both ChannelInboundHandler and ChannelOutboundHandler, the evaluation order of an inbound and a outbound event could be 125 and 543 respectively.
</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºäº†ï¼š</p>
<ul>
<li>å¯¹äºå…¥ç«™æ•°æ®(input)ï¼Œå°†ä¼šä»ChannelPipelineçš„å¤´éƒ¨å¼€å§‹è°ƒç”¨handlerï¼Œè·³è¿‡æ²¡æœ‰å®ç°ChannelInboundHandlerçš„handler</li>
<li>å¯¹äºå‡ºç«™æ•°æ®(output)ï¼Œå°†ä¼šä»ChannelPipelineçš„å°¾éƒ¨å¼€å§‹è°ƒç”¨handlerï¼Œè·³è¿‡æ²¡æœ‰å®ç°ChannelOutboundHandlerçš„handler</li>
</ul>
<p>ç”±æ­¤ï¼Œå¯ä»¥ç»˜å‡ºä¸€å¼ ç®€å•çš„ç¤ºä¾‹å›¾:</p>
<pre tabindex="0"><code>   Input         Output    Channel Pipeline
+----+-------------^---+
|    |             |   |&lt;---First
| +--v-------------+-+ |
| |                  | |
| |   Handler        | |
| |                  | |
| +--+-------------^-+ |
|    |             |   |
| +--v-------------+-+ |
| |                  | |
| |   Handler        | |
| |                  | |
| +--+-------------^-+ |
|    |             |   |
| +--v-------------+-+ |
| |                  | |
| |   Handler        | |
| |                  | |
| |                  | |
| +--+-------------^-+ |
|    |             |   |
| +--v-------------+-+ |
| |                  | |
| |   Handler        | |
| |                  | |
| +--+---------------+ |
|    |             ^   |
|    |             |   |&lt;---Last
+----+-------------+---+
     |             |
     +-------------+

     å¦‚æœhandleræœªå®ç°ChannelInboundHandler;ChannelOutboundHandler;å°†ä¼šè·³è¿‡Input;Outputé˜¶æ®µã€‚
</code></pre><p>å°†å¼€å¤´çš„æºä»£ç ä¿®æ­£ï¼Œç»“æœå°†ä¼šæ˜¯:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">var</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
        <span class="c1">// æ·»åŠ ä¸€ä¸ªè§£ç å™¨æ¥è§£ææ•°æ®é•¿åº¦
</span><span class="c1"></span>        <span class="n">pipeline</span>
                <span class="c1">// æ·»åŠ ä¸€ä¸ªæ‹†åŒ…å™¨ (input)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;packet length parser&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
                        <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
                        <span class="n">0</span><span class="o">,</span>
                        <span class="n">4</span><span class="o">,</span>
                        <span class="n">0</span><span class="o">,</span>
                        <span class="c1">// ä¸¢å¼ƒé•¿åº¦
</span><span class="c1"></span>                        <span class="n">4</span>
                <span class="o">))</span>
                <span class="c1">// æ·»åŠ ä¸€ä¸ªåŒ…åˆ†ç±»å™¨ (input)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;packet classifier&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">PacketClassifier</span><span class="o">())</span>
                <span class="c1">// æ·»åŠ ä¸€ä¸ªè¾“å‡ºè§£ç å™¨ (output)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;output encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">PacketEncoder</span><span class="o">())</span>
                <span class="c1">// æ·»åŠ ä¸€äº›å®é™…å¤„ç†åŒ…çš„handle(input &amp;&amp; output)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;packet ping handle&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">PingPacketHandle</span><span class="o">())</span>
                <span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯¹äºæ•°æ®ï¼Œå°†ç»è¿‡:</p>
<pre tabindex="0"><code>    input                   output
    |                       |
    â†“                       â†‘
    packet length parser    output encoder
    â†“                       â†‘
    packet classifier       |
    â†“                       â†‘
    â†’ -------------------â†’  packet ping handle
</code></pre><p>well done</p>
<p>æ›´å¤šå†…å®¹å¯ä»¥å‚è§:https://www.cnblogs.com/tianzhiliang/p/11739372.html</p>
<!--TODO-->
    </div>

    
    <div class="postFooter">
        <p>Posted by MingMoe.</p>
        <p>Last update Saturday, October 23, 2021.</p>
    </div>

</div>


        </main>
        
        
        


<aside class="mingSider">

    <p>æ¬¢è¿æ¥åˆ°æœ¬ç«™[]~ï¼ˆï¿£â–½ï¿£ï¼‰~*</p>

    
    <div>
        <iframe style="overflow: hidden;display: flex;width:100%" width="300" height="30" frameborder="0" scrolling="no" hspace="0" src="https://i.tianqi.com/index.php?c=code&id=34&icon=1"></iframe>
    </div>

    
    <div>
        <a class="twitter-timeline" data-lang="zh-cn" data-height="2048" href="https://twitter.com/ming_moe_?ref_src=twsrc%5Etfw">Tweets by ming_moe_</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>

</aside>
    </div>

    
    

<footer class="mingFooter">

    <p>Powered by <a href="https://gohugo.io/">Hugo</a>.Copyright Â©  2021 MingMoe.<br>

    <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
        <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®
        </a>è¿›è¡Œè®¸å¯ã€‚

    </p>

</footer>

</body>


</html>
